# CVE Vulnerability Scanning and Remediation Instructions

## Overview
These instructions guide an AI coding agent to scan Java/Gradle projects for Common Vulnerabilities and Exposures (CVE) in dependencies and apply appropriate fixes.

## Environment Assumptions
- Platform: macOS (Macbook)
- Build tool: Gradle with Groovy DSL (build.gradle)
  - **Note:** Instructions are specific to Gradle with Groovy. For Maven or Gradle with Kotlin DSL, this file requires adaptation.
- Internet connectivity for downloading CVE database and updated dependencies

## Prerequisites
- Project must build successfully before running CVE scan
- All compilation errors must be resolved
- Unit tests should be passing

## Important: Build Tool Scope

**ONLY scan and fix Gradle-based projects.** This applies exclusively to:
- `build.gradle` or `build.gradle.kts`
- `gradle.properties`
- `settings.gradle` or `settings.gradle.kts`

**DO NOT modify Maven-based projects.** Specifically, do not modify:
- `pom.xml`
- Maven-specific configuration files

If the project uses Maven instead of Gradle, adapt these instructions for Maven's OWASP Dependency-Check plugin.

---

## Guidelines for AI Agent Execution

When executing these instructions, the AI agent should:

1. **Provide Clear Feedback**: After each step, provide clear feedback about what was found (e.g., "Found 3 high-severity CVEs", "No vulnerabilities detected", "Updated dependency to secure version")

2. **Prioritize by Severity**: Address vulnerabilities in order: Critical â†’ High â†’ Medium â†’ Low

3. **Verify Fixes**: After updating dependencies, re-run tests to ensure compatibility

4. **Document Decisions**: When suppressing vulnerabilities or accepting risks, document the reasoning

5. **Avoid Breaking Changes**: When updating dependencies, prefer patch/minor version updates over major version updates to minimize breaking changes

---

## Step 1: Add OWASP Dependency-Check Plugin

### 1.1 Check if Plugin Already Exists

Check if the OWASP Dependency-Check plugin is already configured in [build.gradle](build.gradle):

```bash
grep -q "org.owasp.dependencycheck" build.gradle && echo "OWASP Dependency-Check plugin found" || echo "OWASP Dependency-Check plugin not found"
```

### 1.2 Add Plugin to build.gradle (if not present)

If the plugin is not present, add it to the `plugins` section of [build.gradle](build.gradle):

```groovy
plugins {
  // ... existing plugins ...
  id 'org.owasp.dependencycheck' version '10.0.4'
}
```

**Note:** Version 10.0.4 or later is recommended. Check [OWASP Dependency-Check Releases](https://github.com/jeremylong/DependencyCheck/releases) for the latest version.

### 1.3 Configure Dependency-Check

Add configuration for the OWASP Dependency-Check plugin in [build.gradle](build.gradle):

```groovy
dependencyCheck {
  // Automatically update the CVE database
  autoUpdate = true

  // Fail build on CVSS scores equal to or above (0-10)
  // 0 = only warn, 7 = high severity and above, 9 = critical only
  failBuildOnCVSS = 7

  // Output formats (HTML for human review, JSON for automation)
  formats = ['HTML', 'JSON', 'XML']

  // Suppression file for known false positives (optional)
  // Uncomment if you create a suppression file
  // suppressionFile = file('dependency-check-suppressions.xml')

  // Analyze only runtime and compile dependencies
  // Skip test-only dependencies if desired
  skipConfigurations = ['testImplementation', 'testRuntimeOnly']

  // Set analyzer options
  analyzers {
    // Enable/disable specific analyzers
    assemblyEnabled = false
    nuspecEnabled = false
    nodeEnabled = false
  }
}
```

### 1.4 Verify Plugin Configuration

After adding the plugin, verify the configuration:

```bash
./gradlew tasks --group="OWASP dependency-check"
```

Expected output should show available dependency-check tasks:
```
OWASP dependency-check tasks
----------------------------
dependencyCheckAnalyze - Identifies and reports known vulnerabilities in dependencies
dependencyCheckAggregate - Identifies and reports known vulnerabilities in multi-project dependencies
dependencyCheckPurge - Purges the local cache of the NVD data
dependencyCheckUpdate - Updates the local cache of the NVD data
```

---

## Step 2: Run CVE Vulnerability Scan

### 2.1 Execute Dependency Check Analysis

Run the OWASP Dependency-Check to scan all dependencies for known vulnerabilities:

```bash
./gradlew dependencyCheckAnalyze
```

**Important Notes:**
- First run will download the National Vulnerability Database (NVD), which may take 5-15 minutes
- Subsequent runs will be faster (1-3 minutes) as they only download updates
- The task will analyze all project dependencies and check them against the NVD

### 2.2 Monitor Scan Progress

The scan will display progress information:
```
> Task :dependencyCheckAnalyze
Checking for updates
Updating the NVD CVE data
Processing 1/1 artifacts
Analysis Complete
```

### 2.3 Check Scan Results Location

After completion, reports are generated in:
```
build/reports/dependency-check-report.html
build/reports/dependency-check-report.json
build/reports/dependency-check-report.xml
```

Verify the reports were created:

```bash
ls -lh build/reports/dependency-check-report.*
```

---

## Step 3: Review Vulnerability Report

### 3.1 Open HTML Report

Open the HTML report for human-readable review:

```bash
# macOS
open build/reports/dependency-check-report.html

# Linux
xdg-open build/reports/dependency-check-report.html
```

### 3.2 Parse JSON Report for Automation

Alternatively, parse the JSON report to extract vulnerability details programmatically:

```bash
# Count total vulnerabilities
cat build/reports/dependency-check-report.json | grep -o '"severity":"[^"]*"' | sort | uniq -c

# List all vulnerable dependencies
cat build/reports/dependency-check-report.json | grep -o '"fileName":"[^"]*"' | sort | uniq
```

### 3.3 Understand Report Structure

The report contains:
- **Summary**: Total dependencies scanned, total vulnerabilities found
- **Dependencies**: List of all analyzed dependencies
- **Vulnerabilities**: For each vulnerable dependency:
  - **CVE ID**: Official CVE identifier (e.g., CVE-2024-12345)
  - **CVSS Score**: Severity rating (0-10)
    - 0.0: None
    - 0.1-3.9: Low
    - 4.0-6.9: Medium
    - 7.0-8.9: High
    - 9.0-10.0: Critical
  - **Description**: What the vulnerability is
  - **Vulnerable Versions**: Which versions are affected
  - **References**: Links to CVE details and advisories

### 3.4 Categorize Vulnerabilities by Severity

Extract and categorize findings:

```bash
echo "=== Vulnerability Summary ==="
echo ""
echo "Critical (CVSS 9.0-10.0):"
grep -o '"severity":"CRITICAL"' build/reports/dependency-check-report.json | wc -l | tr -d ' '

echo "High (CVSS 7.0-8.9):"
grep -o '"severity":"HIGH"' build/reports/dependency-check-report.json | wc -l | tr -d ' '

echo "Medium (CVSS 4.0-6.9):"
grep -o '"severity":"MEDIUM"' build/reports/dependency-check-report.json | wc -l | tr -d ' '

echo "Low (CVSS 0.1-3.9):"
grep -o '"severity":"LOW"' build/reports/dependency-check-report.json | wc -l | tr -d ' '
```

---

## Step 4: Fix Critical and High Severity Vulnerabilities

### 4.1 Identify Vulnerable Dependencies

For each Critical or High severity vulnerability (CVSS â‰¥ 7.0), identify:
1. The vulnerable library name and version
2. The CVE ID(s)
3. The fixed version (if available)

### 4.2 Check Gradle Dependency Tree

Determine where the vulnerable dependency is declared:

```bash
# Find all dependencies and their versions
./gradlew dependencies > dependencies.txt

# Search for specific vulnerable dependency
./gradlew dependencies | grep -i "<vulnerable-library-name>"
```

This will show whether the dependency is:
- **Direct dependency**: Declared in your [build.gradle](build.gradle)
- **Transitive dependency**: Pulled in by another library

### 4.3 Update Direct Dependencies

If the vulnerable dependency is directly declared in [build.gradle](build.gradle), update it to the patched version:

**Example - Before:**
```groovy
dependencies {
  implementation 'com.fasterxml.jackson.core:jackson-databind:2.12.3'
}
```

**Example - After:**
```groovy
dependencies {
  implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.3'
}
```

**Steps:**
1. Identify the current version in [build.gradle](build.gradle)
2. Find the latest secure version from:
   - The CVE report recommendations
   - [Maven Central](https://search.maven.org/)
   - The library's GitHub releases page
3. Update the version in [build.gradle](build.gradle)
4. Proceed to Step 4.6 to verify the fix

### 4.4 Update Transitive Dependencies

If the vulnerable dependency is transitive (not directly declared), you have several options:

#### Option A: Update Parent Dependency

Update the direct dependency that pulls in the vulnerable transitive dependency:

```groovy
dependencies {
  // Update the parent library to a version that uses a secure transitive dependency
  implementation 'com.example:parent-library:2.0.0'  // was 1.5.0
}
```

#### Option B: Force Dependency Resolution

Force Gradle to use a specific version of the transitive dependency:

```groovy
configurations.all {
  resolutionStrategy {
    force 'com.example:vulnerable-library:2.5.0'
  }
}
```

#### Option C: Exclude and Replace

Exclude the vulnerable transitive dependency and add the secure version directly:

```groovy
dependencies {
  implementation('com.example:parent-library:1.5.0') {
    exclude group: 'com.example', module: 'vulnerable-library'
  }

  // Add secure version directly
  implementation 'com.example:vulnerable-library:2.5.0'
}
```

### 4.5 Handle Dependencies Without Patches

If no patched version exists:

#### Strategy 1: Find Alternative Libraries

Search for actively maintained alternatives:
1. Check if the library is still maintained (last commit date, open issues)
2. Search for similar libraries with better security track records
3. Evaluate migration effort vs security risk
4. If feasible, migrate to the alternative library

#### Strategy 2: Apply Workarounds

If no alternatives exist and the vulnerability is not exploitable in your usage:
1. Verify the vulnerable code path is not used in your application
2. Add application-layer security controls (input validation, sanitization)
3. Document the risk acceptance decision
4. Monitor for future patches

#### Strategy 3: Suppress Known False Positives

If the CVE is a false positive (doesn't apply to your usage), create a suppression file.

**Create `dependency-check-suppressions.xml` in project root:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd">
    <suppress>
        <notes><![CDATA[
        CVE-2024-12345: False positive - This vulnerability affects the HTTP server component
        which is not used in our application. We only use the client library functions.
        Documented on: 2024-01-15
        Reviewed by: Security Team
        ]]></notes>
        <packageUrl regex="true">^pkg:maven/com\.example/vulnerable\-library@.*$</packageUrl>
        <cve>CVE-2024-12345</cve>
    </suppress>
</suppressions>
```

**Enable suppression file in [build.gradle](build.gradle):**

```groovy
dependencyCheck {
  // ... other configuration ...
  suppressionFile = file('dependency-check-suppressions.xml')
}
```

### 4.6 Verify Fix Works

After updating dependencies, verify the fix:

1. **Rebuild the project:**
   ```bash
   ./gradlew clean build
   ```

2. **Run tests:**
   ```bash
   ./gradlew test
   ```

3. **Re-run dependency check:**
   ```bash
   ./gradlew dependencyCheckAnalyze
   ```

4. **Verify vulnerability is resolved:**
   - Check the new report
   - Confirm the CVE no longer appears
   - Ensure no new vulnerabilities were introduced

### 4.7 Iterate for All Critical/High Vulnerabilities

Repeat Steps 4.1-4.6 for each Critical and High severity vulnerability until all are resolved.

---

## Step 5: Address Medium Severity Vulnerabilities

### 5.1 Evaluate Risk Context

For Medium severity vulnerabilities (CVSS 4.0-6.9):
1. Assess whether the vulnerable code is used in your application
2. Determine if the vulnerability is exploitable in your environment
3. Consider the effort required to update vs the actual risk

### 5.2 Update When Feasible

If the update is low-risk (patch or minor version bump):
- Follow the same process as Step 4 to update the dependency
- Verify compatibility with tests

### 5.3 Document Risk Acceptance

If updating is not feasible (e.g., would require major refactoring):
1. Document the vulnerability and why it's accepted
2. Add to suppression file with detailed notes
3. Set a reminder to revisit during the next maintenance cycle

**Example suppression for accepted risk:**

```xml
<suppress>
    <notes><![CDATA[
    CVE-2024-67890: Medium severity (CVSS 5.3) - Path traversal vulnerability
    Risk accepted because:
    - The affected component is only used in internal admin tools
    - Access is restricted to authenticated administrators only
    - Additional input validation exists at application layer
    To be revisited during Q2 2025 maintenance cycle
    Documented on: 2024-01-15
    Approved by: Tech Lead
    ]]></notes>
    <packageUrl regex="true">^pkg:maven/com\.example/admin\-lib@.*$</packageUrl>
    <cve>CVE-2024-67890</cve>
</suppress>
```

---

## Step 6: Handle Low Severity Vulnerabilities

### 6.1 Review Low Severity Issues

Low severity vulnerabilities (CVSS < 4.0) typically:
- Require specific conditions to exploit
- Have limited impact
- May be theoretical or require local access

### 6.2 Planned Updates

For low severity vulnerabilities:
1. **Document them** for awareness
2. **Plan updates** during regular dependency maintenance cycles
3. **Update opportunistically** when updating the dependency for other reasons
4. **Don't prioritize** over feature work or higher-severity issues

### 6.3 Suppress for Tracking

Add to suppression file to track without failing builds:

```xml
<suppress until="2025-06-30Z">
    <notes><![CDATA[
    CVE-2024-11111: Low severity (CVSS 2.1)
    Planned for update during Q2 2025 dependency refresh
    ]]></notes>
    <packageUrl regex="true">^pkg:maven/com\.example/util\-lib@.*$</packageUrl>
    <cve>CVE-2024-11111</cve>
</suppress>
```

**Note:** The `until` attribute will automatically remove the suppression after the specified date, forcing re-evaluation.

---

## Step 7: Final Verification

### 7.1 Run Complete Test Suite

After all vulnerability fixes:

```bash
# Clean build
./gradlew clean build

# Run all tests
./gradlew test

# Run integration tests (if configured)
./gradlew integrationTest
```

### 7.2 Run Final CVE Scan

Execute final dependency check to confirm all addressed:

```bash
./gradlew dependencyCheckAnalyze
```

### 7.3 Verify Build Passes CVSS Threshold

Ensure the build passes the configured CVSS threshold (default: 7.0):

```bash
./gradlew clean dependencyCheckAnalyze
```

If the build fails due to remaining high-severity CVEs, review Step 4 to ensure all were addressed.

### 7.4 Review Final Report

Open the final report and verify:
- All Critical vulnerabilities resolved
- All High vulnerabilities resolved
- Medium/Low vulnerabilities either resolved or documented/suppressed

```bash
open build/reports/dependency-check-report.html
```

### 7.5 Generate Summary Report

Create a summary of actions taken:

```bash
echo "=== CVE Remediation Summary ===" > cve-remediation-summary.txt
echo "" >> cve-remediation-summary.txt
echo "Scan Date: $(date)" >> cve-remediation-summary.txt
echo "" >> cve-remediation-summary.txt
echo "Vulnerabilities Found:" >> cve-remediation-summary.txt
grep -o '"severity":"[^"]*"' build/reports/dependency-check-report.json | sort | uniq -c >> cve-remediation-summary.txt
echo "" >> cve-remediation-summary.txt
echo "Dependencies Updated:" >> cve-remediation-summary.txt
git diff build.gradle | grep "^[+-].*implementation\|^[+-].*api\|^[+-].*runtimeOnly" >> cve-remediation-summary.txt
echo "" >> cve-remediation-summary.txt
echo "See full report at: build/reports/dependency-check-report.html" >> cve-remediation-summary.txt

cat cve-remediation-summary.txt
```

---

## Step 8: Commit Changes (Optional)

If all tests pass and vulnerabilities are resolved, consider committing the changes:

### 8.1 Review Changes

```bash
git status
git diff build.gradle
git diff dependency-check-suppressions.xml
```

### 8.2 Stage Changes

```bash
git add build.gradle
git add dependency-check-suppressions.xml  # if created
git add cve-remediation-summary.txt  # if created
```

### 8.3 Commit with Descriptive Message

```bash
git commit -m "$(cat <<'EOF'
security: Fix CVE vulnerabilities in dependencies

- Updated vulnerable dependencies to patched versions
- Addressed [X] critical, [Y] high, [Z] medium severity CVEs
- Added suppression file for documented false positives
- All tests passing

Details in cve-remediation-summary.txt

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Step 9: Enable Continuous CVE Monitoring (Optional)

### 9.1 Add to CI/CD Pipeline

Add dependency check to GitHub Actions workflow:

**Example: `.github/workflows/dependency-check.yml`**

```yaml
name: OWASP Dependency Check

on:
  schedule:
    - cron: '0 2 * * 1'  # Run every Monday at 2 AM
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  dependency-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Run OWASP Dependency Check
        run: ./gradlew dependencyCheckAnalyze --no-daemon

      - name: Upload Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-check-report
          path: build/reports/dependency-check-report.*

      - name: Fail on High/Critical CVEs
        run: |
          if grep -q '"severity":"CRITICAL"\|"severity":"HIGH"' build/reports/dependency-check-report.json; then
            echo "High or Critical severity vulnerabilities found!"
            exit 1
          fi
```

### 9.2 Enable GitHub Dependabot

Enable Dependabot for automatic dependency updates:

**Create `.github/dependabot.yml`:**

```yaml
version: 2
updates:
  - package-ecosystem: "gradle"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
    reviewers:
      - "your-team"
    labels:
      - "dependencies"
      - "security"
```

### 9.3 Configure Dependabot Security Updates

In GitHub repository settings:
1. Go to **Settings** â†’ **Security** â†’ **Dependabot**
2. Enable **Dependabot alerts**
3. Enable **Dependabot security updates**

This will automatically create PRs when vulnerabilities are detected in dependencies.

---

## Troubleshooting

### Issue: NVD Download Fails

**Error:** `Unable to update the NVD data`

**Solution:**
- Check internet connectivity
- Verify firewall/proxy settings
- Try purging and re-downloading: `./gradlew dependencyCheckPurge && ./gradlew dependencyCheckUpdate`

### Issue: False Positives

**Error:** CVE reported for dependency but doesn't apply to your usage

**Solution:**
- Verify the CVE details and affected component
- Add suppression with detailed notes (see Step 4.5)
- Consider reporting false positive to OWASP Dependency-Check

### Issue: Updated Dependency Breaks Build

**Error:** Tests fail after updating vulnerable dependency

**Solution:**
1. Check release notes for breaking changes
2. Update your code to use new API if needed
3. Consider updating to a patch/minor version instead of major
4. If migration is complex, add to suppression and plan for future cycle

### Issue: No Patched Version Available

**Error:** Vulnerable dependency has no fixed version

**Solution:**
1. Check if maintainers are aware (GitHub issues)
2. Consider forking and patching yourself
3. Find alternative library
4. Add workarounds and suppress with documentation

---

## Best Practices

1. **Run CVE scans regularly**: Weekly or before each release
2. **Prioritize by severity**: Critical/High first, Medium/Low as feasible
3. **Test after updates**: Always run full test suite after dependency updates
4. **Document suppressions**: Include detailed reasoning for any suppressed CVEs
5. **Stay informed**: Subscribe to security advisories for your key dependencies
6. **Automate monitoring**: Use CI/CD and Dependabot for continuous monitoring
7. **Review transitive dependencies**: Don't just focus on direct dependencies
8. **Keep suppression file updated**: Review and remove outdated suppressions regularly

---

## References

- [OWASP Dependency-Check](https://jeremylong.github.io/DependencyCheck/)
- [OWASP Dependency-Check Gradle Plugin](https://jeremylong.github.io/DependencyCheck/dependency-check-gradle/index.html)
- [National Vulnerability Database (NVD)](https://nvd.nist.gov/)
- [CVSS Score Calculator](https://www.first.org/cvss/calculator/3.1)
- [GitHub Dependabot Documentation](https://docs.github.com/en/code-security/dependabot)
- [Maven Central Repository](https://search.maven.org/)